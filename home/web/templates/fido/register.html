<html>
<head>
    <title>FIDO Registration</title>
    {% assets "fido_js" %}
        <script type="text/javascript" src="{{ ASSET_URL }}"></script>
    {% endassets %}
    <style>
        body { font-family: sans-serif; line-height: 1.5em; padding: 2em 10em; }
        h1, h2 { color: #325F74; }
        a { color: #0080ac; font-weight: bold; text-decoration: none;}
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
<h1>Enroll FIDO2 Token</h1>
<p>This process requires a browser supporting the WebAuthn API!</p>
<hr>

<h2>Register a credential</h2>
<p>Touch your authenticator device now...</p>
<a href="/">Cancel</a>

<script>
    fetch('/api/user/fido2/register', {
        method: 'POST',
        credentials: 'same-origin',
    }).then(function(response) {
        if(response.ok) return response.arrayBuffer();
        throw new Error('Error getting registration data!');
    }).then(CBOR.decode).then(function(options) {
        return navigator.credentials.create(options);
    }).then(function(attestation) {
        return fetch('/api/user/fido2/complete', {
            method: 'POST',
            headers: {'Content-Type': 'application/cbor'},
            body: CBOR.encode({
                "attestationObject": new Uint8Array(attestation.response.attestationObject),
                "clientDataJSON": new Uint8Array(attestation.response.clientDataJSON),
            })
        });
    }).then(function(response) {
        var stat = response.ok ? 'successful' : 'unsuccessful';
        alert('Registration ' + stat);
    }, function(reason) {
        alert(reason);
    }).then(function() {
        window.location = '/';
    });
</script>

</body>
</html>